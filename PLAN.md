# Facts on Daily News – V2 Implementation Plan

## Overview
Transform from news aggregator (links to external articles) → AI-powered news platform (original articles generated by Grok, stored in Supabase, with graceful RSS fallback).

## Architecture Decision
- **Supabase is NOT configured yet** – all Supabase operations must gracefully fallback
- When Supabase is unavailable: use existing RSS/NewsAPI/Mediastack flow unchanged
- When Supabase is available: full article generation pipeline activates

---

## Phase 1: Database & Infrastructure Layer

### 1.1 Install dependencies
```bash
npm install @supabase/supabase-js
```

### 1.2 Create Supabase client with fallback
**New file: `src/lib/supabase.ts`**
- Initialize Supabase client from env vars (SUPABASE_URL, SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY)
- Export `getSupabase()` that returns client or null
- Export `isSupabaseConfigured()` boolean helper
- Server-side client uses service role key
- No crash if env vars missing

### 1.3 Define article types
**Modify: `src/lib/types.ts`**
- Add `Article` interface (id, title, summary, body, category, sub_category, fact_score, fact_details, interest_tags, sources, is_gossip, created_at, updated_at, published)
- Add `RawSource` interface (id, title, description, url, source_name, published_at, fetched_at, category, sub_category, raw_content, processed)
- Add `ArticleSource` type for the sources JSONB field
- Keep all existing types unchanged

---

## Phase 2: Article Generation Pipeline

### 2.1 Source ingestion
**New file: `src/lib/pipeline/ingest.ts`**
- Function `ingestSources()`: fetches from RSS + NewsAPI + Mediastack
- Converts NewsItem[] to RawSource format
- If Supabase available: upsert into raw_sources (skip duplicates by URL)
- If Supabase unavailable: return in-memory array
- Deduplication by URL

### 2.2 Source grouping
**New file: `src/lib/pipeline/grouping.ts`**
- Function `groupRelatedSources(sources: RawSource[])`: groups 2-5 sources about same topic
- Uses Grok (grok-3-mini-fast) to identify related news items
- Returns grouped arrays ready for article generation

### 2.3 Article generation
**New file: `src/lib/pipeline/generate.ts`**
- Function `generateArticle(sources: RawSource[])`: sends grouped sources to Grok
- Uses grok-3-mini for quality article writing
- Prompt from SCOPE_V2_ARTICLES.md (Danish, objective, JSON output)
- Returns Article object
- Rate limit: max 50 articles per hour

### 2.4 Pipeline orchestrator
**New file: `src/lib/pipeline/index.ts`**
- Function `runPipeline()`: orchestrates full flow
  1. Ingest sources
  2. Group related sources
  3. Generate articles for each group
  4. Save to Supabase (if available)
- Handles errors gracefully per-group (don't fail entire pipeline)

---

## Phase 3: API Endpoints

### 3.1 Articles API
**New file: `src/app/api/articles/route.ts`**
- GET: Fetch articles from Supabase (paginated, filtered by category/subCategory/tags)
- Fallback: if Supabase unavailable, return empty array with `fallback: true` flag
- Query params: category, subCategory, tag, page, limit

### 3.2 Single article API
**New file: `src/app/api/articles/[id]/route.ts`**
- GET: Fetch single article by ID from Supabase
- Returns full article with body, sources, fact_details

### 3.3 Source fetch cron endpoint
**New file: `src/app/api/sources/fetch/route.ts`**
- POST: Triggered by Vercel cron every 30 min
- Validates CRON_SECRET
- Calls ingestSources()
- Returns count of new sources

### 3.4 Article generation cron endpoint
**New file: `src/app/api/articles/generate/route.ts`**
- POST: Triggered by Vercel cron every 15 min
- Validates CRON_SECRET
- Calls runPipeline()
- Returns count of generated articles

### 3.5 Keep existing endpoints
- `/api/news` – unchanged (RSS fallback flow)
- `/api/factcheck` – unchanged

---

## Phase 4: UI Components & Pages

### 4.1 ArticleCard component
**New file: `src/components/ArticleCard.tsx`**
- Title (clickable → article detail page)
- Summary (2-3 lines)
- Fact score badge (reuse FactScore component)
- Source count ("Baseret på 3 kilder")
- Interest tags
- Timestamp (time ago)
- Visual distinction from NewsCard

### 4.2 Article detail page
**New file: `src/app/article/[id]/page.tsx`**
- Full article in nice typography (render markdown body)
- Fact score with expandable details
- Sources section at bottom (links to original articles)
- Related articles sidebar/section
- Back button to dashboard

### 4.3 useArticles hook
**New file: `src/hooks/useArticles.ts`**
- Similar pattern to useNews hook
- Fetches from /api/articles
- Handles pagination, filtering
- Returns { articles, loading, error, loadMore, hasMore }

### 4.4 Update main page
**Modify: `src/app/page.tsx`**
- Check if articles are available (Supabase mode)
- If articles available: show ArticleCards
- If not: show existing NewsCards (RSS fallback)
- Keep tab navigation (Danmark/Europa/Verden/Sladder)
- Keep sub-tabs (Generelt/Finans)
- Add "Load more" button or infinite scroll

### 4.5 Markdown renderer
**Install: react-markdown + remark-gfm** (or simple custom renderer)
- For rendering article body markdown to HTML
- Style with Tailwind prose classes

---

## Phase 5: Cron & Deployment Config

### 5.1 Update vercel.json
**Modify: `vercel.json`**
```json
{
  "crons": [
    { "path": "/api/sources/fetch", "schedule": "*/30 * * * *" },
    { "path": "/api/articles/generate", "schedule": "*/15 * * * *" }
  ],
  "functions": {
    "src/app/api/news/route.ts": { "maxDuration": 25 },
    "src/app/api/factcheck/route.ts": { "maxDuration": 30 },
    "src/app/api/sources/fetch/route.ts": { "maxDuration": 30 },
    "src/app/api/articles/generate/route.ts": { "maxDuration": 60 }
  }
}
```

### 5.2 Update .env.example
Add Supabase env vars (without values):
```
SUPABASE_URL=
SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=
CRON_SECRET=
```

---

## Phase 6: Build & Verify

### 6.1 Build verification
- Run `npx next build` – ensure zero errors
- Verify all existing routes still work
- Verify new routes compile

### 6.2 Git commit
```bash
git add -A
git commit -m 'feat: V2 article generation pipeline'
```

---

## File Summary

### New Files (12)
1. `src/lib/supabase.ts` – Supabase client with fallback
2. `src/lib/pipeline/ingest.ts` – Source ingestion
3. `src/lib/pipeline/grouping.ts` – Source grouping
4. `src/lib/pipeline/generate.ts` – Article generation via Grok
5. `src/lib/pipeline/index.ts` – Pipeline orchestrator
6. `src/app/api/articles/route.ts` – Articles list API
7. `src/app/api/articles/[id]/route.ts` – Single article API
8. `src/app/api/articles/generate/route.ts` – Article generation cron
9. `src/app/api/sources/fetch/route.ts` – Source fetch cron
10. `src/components/ArticleCard.tsx` – Article card component
11. `src/app/article/[id]/page.tsx` – Article detail page
12. `src/hooks/useArticles.ts` – Articles data hook

### Modified Files (4)
1. `src/lib/types.ts` – Add Article, RawSource types
2. `src/app/page.tsx` – Use ArticleCard when available
3. `vercel.json` – Add crons and function configs
4. `package.json` – Add @supabase/supabase-js, react-markdown

### Unchanged Files
- All existing components (NewsCard, Header, Footer, etc.)
- All existing lib files (grok.ts, rss.ts, newsapi.ts, mediastack.ts)
- `/api/news` and `/api/factcheck` routes
- Settings page, Sladder page
